server:
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  global:
    scrape_interval: 5s
    scrape_timeout: 5s
  service:
    type: NodePort
    nodePort: 30090
  extraArgs:
    web.enable-remote-write-receiver: ""

# Additional scrape configs for ME pods (must be at top level, not under server)
extraScrapeConfigs: |
  - job_name: 'matching-engine'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - matching-engine
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+);(.+)
        replacement: $1:$2
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: replace
        target_label: app
      - source_labels: [__meta_kubernetes_pod_label_shard]
        action: replace
        target_label: shard

# Recording rules for pre-computed experiment metrics
serverFiles:
  recording_rules.yml:
    groups:
      - name: matching-engine-experiment
        interval: 5s
        rules:
          # ASR 1: Primary metric -- p99 matching latency per shard
          - record: me:match_duration_p99:30s
            expr: histogram_quantile(0.99, sum(rate(me_match_duration_seconds_bucket{job="matching-engine"}[30s])) by (le, shard))

          - record: me:match_duration_p95:30s
            expr: histogram_quantile(0.95, sum(rate(me_match_duration_seconds_bucket{job="matching-engine"}[30s])) by (le, shard))

          - record: me:match_duration_p50:30s
            expr: histogram_quantile(0.50, sum(rate(me_match_duration_seconds_bucket{job="matching-engine"}[30s])) by (le, shard))

          # ASR 2: Primary metric -- aggregate throughput (matches/min)
          - record: me:matches_per_minute:total
            expr: sum(rate(me_matches_total{job="matching-engine"}[1m])) * 60

          # ASR 2: Per-shard throughput (matches/min)
          - record: me:matches_per_minute:by_shard
            expr: rate(me_matches_total{job="matching-engine"}[1m]) * 60

          # Latency budget: average per sub-component
          - record: me:validation_avg_seconds
            expr: rate(me_order_validation_duration_seconds_sum{job="matching-engine"}[1m]) / rate(me_order_validation_duration_seconds_count{job="matching-engine"}[1m])

          - record: me:orderbook_insertion_avg_seconds
            expr: rate(me_orderbook_insertion_duration_seconds_sum{job="matching-engine"}[1m]) / rate(me_orderbook_insertion_duration_seconds_count{job="matching-engine"}[1m])

          - record: me:matching_algorithm_avg_seconds
            expr: rate(me_matching_algorithm_duration_seconds_sum{job="matching-engine"}[1m]) / rate(me_matching_algorithm_duration_seconds_count{job="matching-engine"}[1m])

          - record: me:wal_append_avg_seconds
            expr: rate(me_wal_append_duration_seconds_sum{job="matching-engine"}[1m]) / rate(me_wal_append_duration_seconds_count{job="matching-engine"}[1m])

          - record: me:event_publish_avg_seconds
            expr: rate(me_event_publish_duration_seconds_sum{job="matching-engine"}[1m]) / rate(me_event_publish_duration_seconds_count{job="matching-engine"}[1m])

          # GC collection time rate (ZGC Pauses -- seconds of GC pause per second)
          - record: me:gc_pause_rate:1m
            expr: rate(jvm_gc_collection_seconds_sum{job="matching-engine", gc="ZGC Pauses"}[1m])

          # Orders received rate
          - record: me:orders_per_second
            expr: sum(rate(me_orders_received_total{job="matching-engine"}[30s]))

alertmanager:
  enabled: false

kube-state-metrics:
  enabled: false

prometheus-node-exporter:
  enabled: false

prometheus-pushgateway:
  enabled: false
